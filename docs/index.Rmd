---
title: "Language Autonomy Research EFA - Group A (N=629) - v0"
author: '[Charles C.](https://mrcharles.dev)'
output:
  html_document:
    toc: true
    number_sections: false
    toc_depth: 2
    theme: cerulean
    highlight: tango
    df_print: paged
    toc_float:
      collapsed: false
      smooth_scroll: true
  pdf_document:
    toc: true
    toc_depth: '2'
    latex_engine: xelatex
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 6.67, fig.height = 6.67, dpi = 300)
```


# NOTES
```{r notes, echo = FALSE, message = FALSE, warning = FALSE}
cat("
- This is a placeholder
- for the time being.
", "\n")
```


# STEP 01: Load the necessary libraries (auto-install if not available already)
```{r step-01, echo = FALSE, message = FALSE, warning = FALSE}
packages <- c(
  "psych",      # personality, psychometric research
  "corrplot",   # correlation matrix visualization
  "lavaan",     # latent variable modeling
  "semPlot",    # SEM path diagrams
  "readr",      # reading rectangular text data
  "OpenMx",     # extended SEM
  "dplyr",      # a grammar of data manipulation
  "tidyr",      # create tidy data
  "tinytex"     # to compile LaTeX documents
)
# Find missing packages
missing_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
# Install missing packages
if (length(missing_packages) > 0) {
  install.packages(missing_packages, repos = "https://cloud.r-project.org")
}
# Load all required packages
lapply(packages, library, character.only = TRUE)
```


# STEP 02: Load dataset into a dataframe
```{r step-02, echo = TRUE, message = FALSE, warning = FALSE}
dataset01 <- read.csv("lar_group_A_629_v0.csv")
names(dataset01) # see the variable names
```


# STEP 03: Select only the necessary continuous variables
```{r step-03, echo = TRUE, message = FALSE, warning = FALSE}
dataset02 <- dataset01 %>%
  select(num_range("item_", 1:89, width = 2)) %>%  # item_01 ... item_89
  select(where(is.numeric))                         # keep continuous only
```


# STEP 04: Assumption check - remove rows with missing values
```{r step-04, echo = TRUE, message = FALSE, warning = FALSE}
# rows with any NA (to inspect)
rows_with_na <- dataset02 %>% filter(if_any(everything(), is.na))
# drop them
dataset02_clean <- dataset02 %>% drop_na()
# quick report
removed <- nrow(dataset02) - nrow(dataset02_clean)
cat("Removed", removed, "rows (", round(100*removed/nrow(dataset02), 1), "%).\n")
```


# STEP 05. Assumption check - statistical: correlation matrix, p-values, CIs
```{r step-05, echo = TRUE, message = FALSE, warning = FALSE}
print (corr.test(dataset02_clean), short = FALSE)
```


# STEP 06. Assumption check - visual: correlation matrix heat map
```{r step-06, echo = TRUE, message = FALSE, warning = FALSE}
corrplot(cor(dataset02_clean), method = "color", addCoef.col = "black", tl.cex = 0.8, number.cex = 0.8)
```


# STEP 07. Bartlett's test of sphericity
```{r step-07, echo = TRUE, message = FALSE, warning = FALSE}
cortest.bartlett(dataset02_clean)
```


# STEP 08. KMO test
```{r step-08, echo = TRUE, message = FALSE, warning = FALSE}
KMO(dataset02_clean)
```


# STEP 09. Determine number of factors using eigenvalues from correlation test and scree plot of eigenvalues
```{r step-09, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_ev <- eigen(cor(dataset02_clean))$values
plot(dataset02_clean_ev, type = "b", main = "Eigenvalues (Scree Test)", xlab = "Factor Number", ylab = "Eigenvalue")
```


# STEP 10. Run parallel analysis to determine number of factors from dataset directly
```{r step-10, echo = TRUE, message = FALSE, warning = FALSE}
fa.parallel(dataset02_clean, fa = "fa", n.iter = 100, show.legend = TRUE, main = "Scree Plot & Parallel Analysis")
```


# STEP 11. EFA with no rotation and using 6 factors
```{r step-11, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_efa_no_rotation <- fa(dataset02_clean, nfactors = 6, rotate = "none", fm = "ml")
print(dataset02_clean_efa_no_rotation$loadings, cutoff = 0.1)
print(dataset02_clean_efa_no_rotation$loadings, cutoff = 0.4)
```


# STEP 12. EFA with no rotation and using 7 factors
```{r step-12, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_efa_no_rotation <- fa(dataset02_clean, nfactors = 7, rotate = "none", fm = "ml")
print(dataset02_clean_efa_no_rotation$loadings, cutoff = 0.1)
print(dataset02_clean_efa_no_rotation$loadings, cutoff = 0.4)
```


# STEP 13. EFA with oblimin rotation and using 6 factors
```{r step-13, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_efa_oblimin_rotation <- fa(dataset02_clean, nfactors = 6, rotate = "oblimin", fm = "ml")
print(dataset02_clean_efa_oblimin_rotation$loadings, cutoff = 0.1)
print(dataset02_clean_efa_oblimin_rotation$loadings, cutoff = 0.4)
```


# STEP 14. EFA with oblimin rotation and using 7 factors (nfactors)
```{r step-14, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_efa_oblimin_rotation <- fa(dataset02_clean, nfactors = 7, rotate = "oblimin", fm = "ml")
print(dataset02_clean_efa_oblimin_rotation$loadings, cutoff = 0.1)
print(dataset02_clean_efa_oblimin_rotation$loadings, cutoff = 0.4)
```


# STEP 15. EFA with varimax rotation and using 6 factors
```{r step-15, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_efa_varimax_rotation <- fa(dataset02_clean, nfactors = 6, rotate = "varimax", fm = "ml")
print(dataset02_clean_efa_varimax_rotation$loadings, cutoff = 0.1)
print(dataset02_clean_efa_varimax_rotation$loadings, cutoff = 0.4)
```


# STEP 16. EFA with varimax rotation and using 7 factors
```{r step-16, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_efa_varimax_rotation <- fa(dataset02_clean, nfactors = 7, rotate = "varimax", fm = "ml")
print(dataset02_clean_efa_varimax_rotation$loadings, cutoff = 0.1)
print(dataset02_clean_efa_varimax_rotation$loadings, cutoff = 0.4)
```


# STEP 17. Visualise factor loadings using pre-determined EFA model (unrotated/oblique/varimax)
```{r step-17, echo = TRUE, message = FALSE, warning = FALSE}
fa.diagram(dataset02_clean_efa_oblimin_rotation, cut=0.2, digits = 3, main = "Factor Loadings Diagram")
#modify above by using the clearest solution, which could be no rotation, oblimin, or varimax
```


# STEP 18. BONUS - use lavaan to do EFA
```{r step-18, echo = TRUE, message = FALSE, warning = FALSE}
dataset02_clean_efa_lavaan <- efa(data = dataset02_clean [,1:87], nfactors = 1:7)
summary(dataset02_clean_efa_lavaan)
```
